---
- name: CVE-2024-3094 Check and Fix
  hosts: all_hosts
  gather_facts: no
  tasks:
    - name: Create results directory
      ansible.builtin.file:
        path: "./results"
        state: directory

    - name: Check which version of XZ is installed
      ansible.builtin.command: xz --version
      register: xz_version

    - name: Check if the version of XZ is vulnerable
      ansible.builtin.command: strings `which xz` | grep '5\.6\.[01]'
      register: xz_vulnerable_version
      ignore_errors: yes

    - name: Save disk usage to local file
      delegate_to: localhost
      run_once: true
      ansible.builtin.copy:
        content: "{{ xz_version.stdout }}"
        dest: "./results/{{ inventory_hostname }}xz_version_results.txt"

    - name: Save memory usage to local file
      delegate_to: localhost
      run_once: true
      ansible.builtin.copy:
        content: "{{ xz_vulnerable_version.stdout }}"
        dest: "./results/{{ inventory_hostname }}xz_vulnerable_version_results.txt"
